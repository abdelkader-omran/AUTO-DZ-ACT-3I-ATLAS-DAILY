#!/usr/bin/env python3
"""
TRIZEL Monitor
Daily snapshot + historical backfill engine

Design principles:
- One snapshot per UTC day (stable filenames)
- Backfill-safe (no archive corruption)
- Explicit overwrite / skip behavior
- No interpretation, only archival provenance
"""

import json
import hashlib
import argparse
from datetime import datetime, date, timedelta, timezone
from pathlib import Path
import sys


# =========================
# Paths
# =========================

ROOT = Path(__file__).resolve().parents[1]
REGISTRY_FILE = ROOT / "registry" / "sources.json"
DATA_DIR = ROOT / "data"
SNAPSHOT_DIR = DATA_DIR / "snapshots"
MANIFEST_DIR = DATA_DIR / "manifests"


# =========================
# Utilities
# =========================

def sha256_bytes(data: bytes) -> str:
    return hashlib.sha256(data).hexdigest()


def parse_utc_date(s: str) -> date:
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except ValueError:
        raise ValueError(f"Invalid date format: {s} (expected YYYY-MM-DD)")


def daterange(start: date, end: date):
    current = start
    while current <= end:
        yield current
        current += timedelta(days=1)


# =========================
# Core writer
# =========================

def write_snapshot_and_manifest(
    target_day: date,
    registry: dict,
    overwrite: bool = False
):
    SNAPSHOT_DIR.mkdir(parents=True, exist_ok=True)
    MANIFEST_DIR.mkdir(parents=True, exist_ok=True)

    day_str = target_day.strftime("%Y-%m-%d")
    retrieved_utc = datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

    snapshot_path = SNAPSHOT_DIR / f"snapshot_{day_str}.json"
    manifest_path = MANIFEST_DIR / f"manifest_{day_str}.json"

    if (snapshot_path.exists() or manifest_path.exists()) and not overwrite:
        print(f"[SKIP] {day_str} already archived")
        return None, None

    snapshot = {
        "schema": "auto-dz-act.snapshot.v1",
        "object": registry.get("object", "3I/ATLAS"),
        "requested_day_utc": day_str,
        "retrieved_utc": retrieved_utc,
        "sources": registry.get("sources", [])
    }

    snapshot_bytes = json.dumps(snapshot, indent=2, sort_keys=True).encode("utf-8")
    snapshot_hash = sha256_bytes(snapshot_bytes)

    snapshot_path.write_bytes(snapshot_bytes)

    manifest = {
        "schema": "auto-dz-act.manifest.v1",
        "requested_day_utc": day_str,
        "retrieved_utc": retrieved_utc,
        "snapshot_file": snapshot_path.name,
        "snapshot_sha256": snapshot_hash,
        "integrity": {
            "generated_automatically": True,
            "no_interpretation_applied": True,
            "overwrite": overwrite
        }
    }

    manifest_bytes = json.dumps(manifest, indent=2, sort_keys=True).encode("utf-8")
    manifest_path.write_bytes(manifest_bytes)

    print(f"[OK] Archived {day_str}")
    return snapshot_path, manifest_path


# =========================
# Main
# =========================

def main():
    parser = argparse.ArgumentParser(
        description="TRIZEL Monitor – daily snapshot or historical backfill"
    )

    # Accept BOTH flag styles (critical fix)
    parser.add_argument(
        "--start", "--start-date",
        dest="start_date",
        help="Backfill start date (YYYY-MM-DD)"
    )

    parser.add_argument(
        "--end", "--end-date",
        dest="end_date",
        help="Backfill end date (YYYY-MM-DD)"
    )

    parser.add_argument(
        "--day",
        help="Run for a single specific UTC day (YYYY-MM-DD)"
    )

    parser.add_argument(
        "--overwrite",
        action="store_true",
        help="Overwrite existing snapshot/manifest files"
    )

    parser.add_argument(
        "--overwrite-today",
        action="store_true",
        help="Overwrite only today's snapshot"
    )

    args = parser.parse_args()

    # Load registry
    if not REGISTRY_FILE.exists():
        print(f"Registry file not found: {REGISTRY_FILE}", file=sys.stderr)
        sys.exit(1)

    with open(REGISTRY_FILE, "r", encoding="utf-8") as f:
        registry = json.load(f)

    today = datetime.now(timezone.utc).date()

    # Determine execution mode
    if args.day:
        start = end = parse_utc_date(args.day)

    elif args.start_date or args.end_date:
        start = parse_utc_date(args.start_date) if args.start_date else today
        end = parse_utc_date(args.end_date) if args.end_date else start

    else:
        start = end = today

    # Overwrite logic
    overwrite = args.overwrite or (args.overwrite_today and start == end == today)

    if start > end:
        print("Start date is after end date.", file=sys.stderr)
        sys.exit(2)

    print(f"Mode: {'BACKFILL' if start != end else 'DAILY'}")
    print(f"Range: {start} → {end}")
    print(f"Overwrite: {overwrite}")
    print("")

    for day in daterange(start, end):
        write_snapshot_and_manifest(
            target_day=day,
            registry=registry,
            overwrite=overwrite
        )


if __name__ == "__main__":
    main()